package com.baidu.gameqa.Gat.executor;

import java.lang.reflect.Method;

import com.baidu.gameqa.Gat.dataobject.EnumObjectManager;
import com.baidu.gameqa.Gat.dataobject.InvokedMethodInfo;
import com.baidu.gameqa.Gat.dataobject.TestObject;
import com.baidu.gameqa.Gat.dataobject.stepparameter.InterfaceMulitStepParameter;
import com.baidu.gameqa.Gat.manager.IManager;
import com.baidu.gameqa.Gat.manager.TestObjectManagerFactory;
import com.baidu.gameqa.Gat.util.GlobalConfig;
import com.baidu.gameqa.Gat.util.ParameterChecker;
import com.baidu.gameqa.Gat.util.StepValuePool;
import com.baidu.gameqa.Lib.common.ClassReflector;
import com.baidu.gameqa.Lib.dbService.DBOperationService;
import com.baidu.gameqa.Lib.dbService.DBProvider;

public abstract class CaseExecutor 
{

	public final void execute() throws Exception
	{
		setUp();
		executeCase();
		tearDown();
	}
	
	public abstract void setUp() throws Exception;
	
	public abstract void executeCase() throws Exception;
	
	public abstract void tearDown() throws Exception;
	
	protected TestObject getTestObject(String objectID,EnumObjectManager testObjectType) throws Exception
	{
		ParameterChecker.StringParameterCheck(testObjectType.name()+"objectID",objectID);
		IManager testObjectManager=TestObjectManagerFactory.getTestObjectManager(testObjectType);
		return testObjectManager.getItem(objectID);
	}
	
	protected void preCleanup()
	{
		StepValuePool.createInstance().getValueDic().remove(GlobalConfig.getPreStepResult());
	}
	
	
	protected  Object invokeMethod(InvokedMethodInfo methodInfo) throws Exception
	{
		Object targetClassInstanceObject= ClassReflector.createInstance(methodInfo.classFullName); //create target instance
		Method targetMethod= ClassReflector.getMethod(targetClassInstanceObject,methodInfo.methodName,methodInfo.parameters.toArray());
		return targetMethod.invoke(targetClassInstanceObject,methodInfo.parameters);
	}
	
	protected void executeSql(String sqlContextID) throws Exception
	{
       InterfaceMulitStepParameter parameters=(InterfaceMulitStepParameter)getTestObject(sqlContextID, EnumObjectManager.IMulitStepParameterManager);
       DBOperationService.executeNoneQuery(parameters.ConnectiongString,parameters.CommandText,DBProvider.Mysql);
	}
	
	protected void invokeDBStep(String dbStepID) throws Exception
	{
		   throw new Exception("not impliement!");
	}
	
	protected InvokedMethodInfo parserPreStepMethodInfo(String methodInfo, Object[] extParameters) throws Exception 
	{
		ParameterChecker.StringParameterCheck("invokeMethod",methodInfo);
    	InvokedMethodInfo resultInfo=new InvokedMethodInfo();
    	if(methodInfo.contains(":"))//has parameter for preStepMethod
		{
			String preStepMethodInfo=methodInfo.split(":")[0];
			resultInfo.parameters.add(methodInfo.split(":")[1]);
		    resultInfo.methodName=preStepMethodInfo.substring(preStepMethodInfo.lastIndexOf(".")+1);
		    resultInfo.classFullName=preStepMethodInfo.replace("."+resultInfo.methodName,"");
		}
		else
		{
			resultInfo.parameters.add("");
			resultInfo.methodName=methodInfo.substring(methodInfo.lastIndexOf(".")+1);
			resultInfo.classFullName=methodInfo.replace("."+resultInfo.methodName,""); 		
		}
    	if(extParameters!=null)
    	{
    		for(Object obj : extParameters)
        	{
        		resultInfo.parameters.add(obj);
        	}
    	}
    	return resultInfo;
    }
}